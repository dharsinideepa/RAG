<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Support GenAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 14rem);
        }
        .message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .message.user {
            background-color: #e2e8f0;
            margin-left: auto;
        }
        .message.assistant {
            background-color: #f0f9ff;
            margin-right: auto;
        }
        .sources {
            display: none;
        }
        .citation {
            background-color: rgba(255, 255, 0, 0.1);
            padding: 0 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="bg-blue-800 text-white p-4 rounded-t-lg">
            <h1 class="text-2xl font-bold">Legal Support GenAI</h1>
            <p class="text-sm">Powered by Llama 3 with RAG</p>
        </header>

        <!-- Main Interface -->
        <div class="flex flex-col md:flex-row gap-4 mt-4">
            <!-- Document Management Panel -->
            <div class="bg-white p-4 rounded-lg shadow-md md:w-1/3">
                <h2 class="text-xl font-semibold mb-4">Document Management</h2>
                
                <!-- Upload Form -->
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Upload Legal Documents</label>
                    <form id="uploadForm" class="flex flex-col gap-2">
                        <input type="file" id="documentFile" class="border rounded p-2" accept=".pdf,.txt,.csv,.docx">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Upload Document
                        </button>
                    </form>
                    <div id="uploadStatus" class="mt-2 text-sm hidden"></div>
                </div>
                
                <!-- Document List -->
                <div>
                    <h3 class="text-lg font-medium mb-2">Your Documents</h3>
                    <div id="documentList" class="border rounded p-2 bg-gray-50 min-h-40 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center p-4">Loading documents...</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="bg-white p-4 rounded-lg shadow-md md:w-2/3 flex flex-col">
                <h2 class="text-xl font-semibold mb-4">Legal Assistant</h2>
                
                <!-- Messages Container -->
                <div id="chatMessages" class="chat-container overflow-y-auto mb-4 p-2">
                    <div class="message assistant">
                        <p>Hello! I'm your legal assistant powered by Llama 3. I can help answer questions about legal documents you've uploaded. How can I assist you today?</p>
                    </div>
                </div>
                
                <!-- Input Container -->
                <div class="mt-auto">
                    <form id="queryForm" class="flex gap-2">
                        <input type="text" id="queryInput" placeholder="Ask a legal question..." 
                               class="flex-grow border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        let messageHistory = [];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            fetchDocuments();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Document upload form
            document.getElementById('uploadForm').addEventListener('submit', handleDocumentUpload);
            
            // Query form
            document.getElementById('queryForm').addEventListener('submit', handleQuery);
        }
        
        async function fetchDocuments() {
            const documentList = document.getElementById('documentList');
            
            try {
                const response = await fetch(`${API_URL}/documents`);
                if (!response.ok) throw new Error('Failed to fetch documents');
                
                const documents = await response.json();
                
                if (documents.length === 0) {
                    documentList.innerHTML = '<p class="text-gray-500 text-center p-4">No documents uploaded yet</p>';
                    return;
                }
                
                const documentItems = documents.map(doc => `
                    <div class="flex justify-between items-center p-2 hover:bg-gray-100">
                        <span class="truncate" title="${doc}">${doc}</span>
                        <button class="delete-document text-red-600 hover:text-red-800" data-filename="${doc}">
                            Delete
                        </button>
                    </div>
                `).join('');
                
                documentList.innerHTML = documentItems;
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-document').forEach(button => {
                    button.addEventListener('click', () => handleDeleteDocument(button.dataset.filename));
                });
                
            } catch (error) {
                console.error('Error fetching documents:', error);
                documentList.innerHTML = '<p class="text-red-500 text-center p-4">Error loading documents</p>';
            }
        }
        
        async function handleDocumentUpload(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('documentFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadStatus('Please select a file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            showUploadStatus('Uploading document...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const result = await response.json();
                showUploadStatus(`${result.filename} uploaded successfully`, 'success');
                fileInput.value = '';
                
                // Refresh document list
                fetchDocuments();
                
            } catch (error) {
                console.error('Error uploading document:', error);
                showUploadStatus(`Upload failed: ${error.message}`, 'error');
            }
        }
        
        async function handleDeleteDocument(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/documents/${filename}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Delete failed');
                }
                
                // Refresh document list
                fetchDocuments();
                
            } catch (error) {
                console.error('Error deleting document:', error);
                alert(`Failed to delete document: ${error.message}`);
            }
        }
        
        async function handleQuery(event) {
            event.preventDefault();
            
            const queryInput = document.getElementById('queryInput');
            const question = queryInput.value.trim();
            
            if (!question) return;
            
            // Add user message to chat
            addMessageToChat(question, 'user');
            
            // Clear input
            queryInput.value = '';
            
            // Display thinking indicator
            const thinkingId = addThinkingIndicator();
            
            try {
                const response = await fetch(`${API_URL}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Query failed');
                }
                
                const result = await response.json();
                
                // Remove thinking indicator
                removeThinkingIndicator(thinkingId);
                
                // Add response to chat
                addMessageToChat(result.answer, 'assistant', result.sources);
                
            } catch (error) {
                console.error('Error querying RAG system:', error);
                
                // Remove thinking indicator
                removeThinkingIndicator(thinkingId);
                
                // Add error message
                addMessageToChat('Sorry, I encountered an error processing your question. Please try again.', 'assistant');
            }
        }
        
        function addMessageToChat(text, sender, sources = []) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Process message text with marked for basic Markdown support
            messageDiv.innerHTML = `<div class="message-content">${marked.parse(text)}</div>`;
            
            // Add sources if available
            if (sources && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'sources';
                sourcesDiv.innerHTML = `
                    <strong>Sources:</strong>
                    <ul class="list-disc pl-5 mt-1">
                        ${sources.map(source => `
                            <li title="${source.source}">${truncateText(source.source, 40)}</li>
                        `).join('')}
                    </ul>
                `;
                messageDiv.appendChild(sourcesDiv);
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in message history
            messageHistory.push({
                sender,
                text,
                sources
            });
        }
        
        function addThinkingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message assistant thinking';
            thinkingDiv.id = 'thinking-' + Date.now();
            thinkingDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>Thinking</span>
                    <span class="inline-block w-1 h-1 bg-blue-600 rounded-full animate-ping"></span>
                    <span class="inline-block w-1 h-1 bg-blue-600 rounded-full animate-ping" style="animation-delay: 0.2s"></span>
                    <span class="inline-block w-1 h-1 bg-blue-600 rounded-full animate-ping" style="animation-delay: 0.4s"></span>
                </div>
            `;
            
            chatMessages.appendChild(thinkingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return thinkingDiv.id;
        }
        
        function removeThinkingIndicator(id) {
            const thinkingDiv = document.getElementById(id);
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }
        
        function showUploadStatus(message, type) {
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = message;
            uploadStatus.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-blue-600');
            
            switch (type) {
                case 'success':
                    uploadStatus.classList.add('text-green-600');
                    break;
                case 'error':
                    uploadStatus.classList.add('text-red-600');
                    break;
                case 'info':
                default:
                    uploadStatus.classList.add('text-blue-600');
            }
            
            uploadStatus.classList.remove('hidden');
            
            // Clear status after 5 seconds
            setTimeout(() => {
                uploadStatus.classList.add('hidden');
            }, 5000);
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.slice(0, maxLength) + '...';
        }
    </script>
</body>
</html>